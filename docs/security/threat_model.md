# Threat Model: AI Video Analysis System

This document outlines the threat model for the AI Video Analysis System, based on the STRIDE methodology.

## 1. System Overview

- **Core Components:** FastAPI backend, n8n for workflows, Qdrant vector database, CVAT for annotation, and a suite of observability tools (Prometheus, Grafana, Loki).
- **Data Flow:** Videos are uploaded or referenced by path. The FastAPI application orchestrates analysis via a worker queue (ARQ on Redis). The analysis involves an ONNX model for inference, with results and embeddings stored in Qdrant. n8n workflows handle post-processing, active learning, and drift detection. CVAT is used for manual data annotation.
- **Assets:**
  - Raw video data
  - Inference results (object detections, classifications)
  - Vector embeddings
  - ML model files (`.onnx`)
  - Annotation data (from CVAT)
  - Application logs and metrics
  - Configuration files and credentials

## 2. Threat Analysis (STRIDE)

| Threat Category             | Scenario                                                                                                                                               | Asset(s) at Risk                                                  | Mitigation Strategy                                                                                                                                                       |
| :-------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **S**poofing                | An unauthenticated attacker impersonates an authorized user to access API endpoints.                                                                   | All data and system functions                                     | Implement API key-based authentication or OAuth2 for all endpoints.                                                                                                       |
|                             | An attacker impersonates the Grafana admin due to default credentials.                                                                                 | Metrics, logs, system performance data                            | Change the default Grafana admin password and store it securely.                                                                                                          |
| **T**ampering               | An attacker modifies a model in the registry by calling the `/registry/models/activate` endpoint to replace the production model with a malicious one. | ML models, inference results                                      | Implement authorization. Only allow admin users to modify the model registry.                                                                                             |
|                             | An attacker poisons the vector database with malicious embeddings, leading to incorrect drift detection or analytics.                                  | Vector embeddings, analytics results                              | Restrict direct write access to Qdrant. All data modifications should go through a validated API endpoint.                                                                |
|                             | An attacker modifies an n8n workflow to exfiltrate data or disrupt processing.                                                                         | All data processed by n8n                                         | Secure the n8n instance with a strong password and disable insecure cookie settings.                                                                                      |
| **R**epudiation             | A user performs a malicious action (e.g., deleting a model) and there is no log to trace the action back to them.                                      | All assets                                                        | Implement comprehensive audit logging for all sensitive actions (model changes, data deletion, etc.). Ensure logs include user identity, timestamp, and action performed. |
| **I**nformation Disclosure  | An attacker exploits a path traversal vulnerability in the `/analyze` endpoint to read sensitive files from the server.                                | Files on the application server, configuration files, source code | Implement strict input validation on all file paths. Sanitize and resolve paths to ensure they stay within a designated data directory.                                   |
|                             | Default credentials for Grafana and CVAT's database are exposed, allowing an attacker to view sensitive logs, metrics, or annotation data.             | Logs, metrics, annotation data                                    | Change all default credentials immediately. Use a secrets management solution instead of hardcoding credentials.                                                          |
|                             | An attacker on the same network sniffs traffic between services, as communication is unencrypted.                                                      | All data in transit                                               | Enforce TLS for all internal service-to-service communication.                                                                                                            |
| **D**enial of Service (DoS) | An attacker sends a large number of requests to the `/analyze` endpoint, overwhelming the worker queue and preventing legitimate analysis.             | System availability                                               | Implement rate limiting on all public-facing API endpoints.                                                                                                               |
|                             | An attacker exploits the insecure `ALLOWED_HOSTS` setting in CVAT to perform a host header injection attack.                                           | CVAT service availability                                         | Configure `ALLOWED_HOSTS` to only include the specific domain of the CVAT instance.                                                                                       |
| **E**levation of Privilege  | An attacker gains access to the host system via excessive volume mounts in the `promtail` container.                                                   | Host system files                                                 | Apply the principle of least privilege. Restrict volume mounts to only the necessary directories and use read-only flags where possible.                                  |
|                             | An attacker with access to the Docker socket could gain root on the host.                                                                              | Host system                                                       | Do not expose the Docker socket to containers.                                                                                                                            |
